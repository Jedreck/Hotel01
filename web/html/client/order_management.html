<!DOCTYPE html>
<html lang="en">

<head>
    <!--load-->
    <script src="../../lib/easyCookie.js"></script>
    <script>
        var cookies_phone = cookie.get("phone");
        var status_val = cookie.get("status");
        if (cookies_phone == null || status_val == null || status_val === "0") {
            top.location.href = "/html/common/index.html";
        }
    </script>
    <!--end load-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Dashboard">
    <meta name="keyword" content="Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">
    <title>订单记录</title>

    <!-- Favicons -->
    <link href="../../img/favicon.png" rel="icon">
    <link href="../../img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Bootstrap core CSS -->
    <link href="../../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!--external css-->
    <link href="../../lib/font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="../../css/zabuto_calendar.css">
    <link rel="stylesheet" type="text/css" href="../../lib/gritter/css/jquery.gritter.css"/>
    <!-- Custom styles for this template -->
    <link href="../../css/style.css" rel="stylesheet">
    <link href="../../css/style-responsive.css" rel="stylesheet">
    <script src="../../lib/chart-master/Chart.js"></script>
    <script type="text/javascript" src="../../lib/layui/layui.all.js"></script>
    <link href="../../lib/layui/css/layui.css" rel="stylesheet" type="text/css"/>
    <script src="../../lib/jquery/jquery.js"></script>

    <!-- =======================================================
      Template Name: Dashio
      Template URL: https://templatemag.com/dashio-bootstrap-admin-template/
      Author: TemplateMag.com
      License: https://templatemag.com/license/
    ======================================================= -->
</head>

<body>
<section id="container">
    <!-- **********************************************************************************************************************************************************
        TOP BAR CONTENT & NOTIFICATIONS
        *********************************************************************************************************************************************************** -->
    <!--header start-->
    <header class="header black-bg">
        <div class="sidebar-toggle-box">
            <div class="fa fa-bars tooltips" data-placement="right" data-original-title="Toggle Navigation"></div>
        </div>
        <!--logo start-->
        <a href="c_main.html" class="logo"><b>酒店<span>预订</span></b></a>
        <!--logo end-->
        <div class="nav notify-row" id="top_menu">
            <!--  notification start -->
            <ul class="nav top-menu">
                <!-- settings start -->
                <li class="dropdown">
                    <a data-toggle="dropdown" class="dropdown-toggle" href="c_main.html#">
                        <i class="fa fa-tasks"></i>
                        <div id="red_num">
                            <span class="badge bg-theme">0</span>
                        </div>
                    </a>
                    <ul class="dropdown-menu extended tasks-bar">
                        <div class="notify-arrow notify-arrow-green"></div>
                        <li>
                            <p class="green">你有待接收的预定</p>
                        </li>
                        <li class="external">
                            <a href="#">查看详情</a>
                        </li>
                    </ul>
                </li>
                <!-- settings end -->
            </ul>
        </div>
        <div class="top-menu">
            <ul class="nav pull-right top-menu">
                <li><a class="logout" onclick="logout()">登出</a></li>
            </ul>
        </div>
    </header>
    <!--header end-->


    <!-- **********************************************************************************************************************************************************
        MAIN SIDEBAR MENU
        *********************************************************************************************************************************************************** -->
    <!--sidebar start-->
    <aside>
        <div id="sidebar" class="nav-collapse ">
            <!-- sidebar menu start-->
            <ul class="sidebar-menu" id="nav-accordion">
                <p class="centered"><a href="c_profile.html"><img src="../../img/ui-sam.jpg" class="img-circle"
                                                                  width="80"></a></p>
                <h5 id="phoneHead" class="centered"></h5>

                <li class="mt">
                    <a class="" href="c_main.html">
                        <i class="glyphicon glyphicon-home"></i>
                        <span>首页</span>
                    </a>
                </li>

                <li class="sub-menu">
                    <a class="" href="c_bookRoom.html">
                        <i class="glyphicon glyphicon-edit"></i>
                        <span>预订房间</span>
                    </a>
                </li>

                <li class="sub-menu">
                    <a href="javascript:;" class="active">
                        <i class="fa fa-cogs"></i>
                        <span>订单管理</span>
                    </a>
                    <ul class="sub" >
                        <li><a href="/html/client/order_cancle.html">取消订单</a></li>
                        <li><a href="/html/client/order_management.html">历史记录</a></li>
                    </ul>
                </li>
            </ul>
            <!-- sidebar menu end-->
        </div>
    </aside>
    <!--sidebar end-->


    <!-- **********************************************************************************************************************************************************
        MAIN CONTENT
        *********************************************************************************************************************************************************** -->
    <!--main content start-->
    <section id="main-content">
        <section class="wrapper">
            <div class="row mt" style="height:600px;">
                <br/>
                <br/>
                <br/>
                <div class="col-md-12">
                    <div class="content-panel">

                        <table class="table table-striped table-advance table-hover">
                            <h4><i class="fa fa-angle-right"></i>订单记录</h4>
                            <hr>
                            <thead>
                            <tr>
                                <th><i class="fa fa-calendar-o">订单号</i></th>
                                <th><i class="fa fa-bullhorn"></i>预定人</th>
                                <th class="hidden-phone"><i class="fa fa-calendar"></i> 入住日期</th>
                                <th><i class="fa fa-bookmark"></i> 订单总价</th>
                                <th><i class=" fa fa-edit"></i> 订单状态</th>
                                <th></th>
                            </tr>
                            </thead>

                            <tbody id="table_content">
                            <!--<tr>-->
                                <!--<td id="order_number">001</td>-->
                                <!--<td class="hidden-phone" id="order_name">李涛</td>-->
                                <!--<td id="check_in_date">2018-12-31</td>-->
                                <!--<td id="order_price">12000.00$</td>-->
                                <!--<td><span class="label label-info label-mini" id="order_state">Due</span></td>-->
                                <!--<td>-->
                                    <!--<button class="btn btn-success btn-xs" name="detail"><i class="fa fa-check"></i></button>-->
                                <!--</td>-->
                            <!--</tr>-->
                            </tbody>

                        </table>

                    </div>
                    <!-- /content-panel -->
                </div>
                <!-- /col-md-12 -->
            </div>

            <!-- /row -->
        </section>
    </section>
    <!--main content end-->

    <!--分页-->

    <div id="order_page" style="text-align: center"></div>
    <!--分页-->


</section>
<!-- js placed at the end of the document so the pages load faster -->
<script src="../../lib/jquery/jquery.min.js"></script>
<script src="../../lib/jquery-ui-1.9.2.custom.min.js"></script>

<script src="../../lib/bootstrap/js/bootstrap.min.js"></script>
<script class="include" type="text/javascript" src="../../lib/jquery.dcjqaccordion.2.7.js"></script>
<script src="../../lib/jquery.scrollTo.min.js"></script>
<script src="../../lib/jquery.nicescroll.js" type="text/javascript"></script>
<script src="../../lib/jquery.sparkline.js"></script>
<!--common script for all pages-->
<script src="../../lib/common-scripts.js"></script>
<script type="text/javascript" src="../../lib/gritter/js/jquery.gritter.js"></script>
<script type="text/javascript" src="../../lib/gritter-conf.js"></script>
<!--script for this page-->
<script src="../../lib/sparkline-chart.js"></script>
<script src="../../lib/zabuto_calendar.js"></script>


<script src="../../lib/layui/layui.js"></script>


<script src="../../lib/my_common.js"></script>
<script>
    //用户小红点、用户身份
    console.log("check cookies--" + cookies_phone);
    console.log("status_val--" + status_val);
    $('#phoneHead').text(cookies_phone);
    window.onload=function(){
        getUnreadNum();
    };
</script>
<script>
    layui.use(['laypage','form','layer'], function(){
        var form = layui.form;
        var laypage = layui.laypage;
        var layer = layui.layer;
    });
</script>
<script type="application/javascript">
    $(function() {

        var cookies_phone = cookie.get("phone");
        console.log(cookies_phone);
        var pageNum = 0;//用来接收订单数量
        var obj;//用来接收查询的订单列表
        var pageNow = 1;// 当前的页

        var CustomerID = "";//当前用户的身份证号

        initialCID(cookies_phone);

        function  initialCID(cookies_phone){
            $.ajax({
                url: "/SelectCIDForCustomerServlet",
                type:'post',
                data:{C_phone:cookies_phone},
                async:false,
                dataType:'text',
                success: function(data){
                    console.log(data);
                    CustomerID = data;
                    if(CustomerID == "") {
                        console.log("ERROR");
                        return;
                    }
                },
                error:  function () {
                    $("#table_content").html("2加载数据失败，请稍后重试!");
                }
            });
        }

        initialData();

        //初始化数据
        function initialData(){
            getData(0,CustomerID);
        }

        /**
         *
         * @param page 当前的页号
         * @param CustomerID 客户的身份证号
         */

        function getData(page,CustomerID) {
            $(document).ajaxStart(function () {
                showProcess("table_content",6);
            });
            $.ajax({
                url: "/GetOrderInfoServlet",
                type:'post',
                data:{page:page,CustomerID:CustomerID},
                dataType:'text',
                success: function(data){
                    var str = data.split("!");
                    var total = parseInt(str[1]);
                    // 后台查询失败
                    if(str == "Error") {
                        $("#table_content").html("1加载数据失败，请稍后重试!");
                        return;
                    }
                    obj = JSON.parse(str[0]);
                    // 后台没有数据
                    if(obj.length == 0) {
                        $("#table_content").html("您没有订单");
                        return
                    }
                    // 后台有>=1条数据
                    initialTable(page+1,obj,total,CustomerID);
                },
                error:  function () {
                    $("#table_content").html("2加载数据失败，请稍后重试!");
                }
            });
        }

        //获取订单状态
        function State(num) {
            switch (num){
                case 0:
                    return "未接受";
                case 1:
                    return "已接受";
                case 2:
                    return "已拒绝";
                case 3:
                    return "已入住";
                case 4:
                    return "已完成";
                case 5:
                    return "已取消";
            }
        }

        /**
         *
         * @param page 当前的页号
         * @param obj 获取当前页的数据
         * @param total 数据总量，用于设置分页
         *  @param CustomerID 用户的身份证号
         */
        // 初始化表格
        function initialTable(page,obj,total,CustomerID){
            pageNum = obj.length;
            setPage(page,total,CustomerID);
            var html = "";
            for(var i = 0; i < obj.length; i++){
                // 拼接内容
                html += "        <tr>\n" +
                    "            <td name=\"order_number\">";
                html += obj[i].O_num;
                html += "</td>\n" +
                    "            <td class=\"hidden-phone\" name=\"order_name\">";
                html += obj[i].C_name;
                html += "</td>\n" +
                    "            <td name=\"check_in_date\">";
                html += obj[i].checkintime.split(" ")[0];
                html += obj[i].checkintime.split(" ")[1];
                html += obj[i].checkintime.split(" ")[2];
                html += "</td>\n" +
                    "            <td name=\"order_price\">";
                html += obj[i].O_price;
                html += "</td>\n" +
                    "             <td name=\"order_status\"><span class=\"label label-info label-mini\">";
                html += State(obj[i].O_status);
                html += "</span></td>\n" +
                    "            <td>\n" +
                    "             <button class=\"btn btn-success btn-xs\" name=\"detail\"><i class=\"fa fa-check\"></i></button>\n" +
                    "            </td>\n" +
                    "            </tr>";
            }
            $("#table_content").html(html);

            // 详细信息和修改
            $("button[name='detail']").click(function () {
                //获取订单号
                var order_number = $($(this).parent().parent()).find("td[name='order_number']").html();
                sessionStorage.setItem("order_number",order_number.trim());//页面之间传递数据
                window.open('./detail_booking_orders.html','_self');
            });

        }



        /**
         *
         * @param page 当前的页号
         * @param total 数据总量，用于设置分页
         *  @param CustomerID 客户的身份证号
         */
        // 设置分页数量
        function setPage(page,total,CustomerID) {
            //console.log(pageNum);
            layui.use(['laypage','form','layer'], function(){
                var form = layui.form;
                var laypage = layui.laypage;
                var layer = layui.layer;
                //执行一个laypage实例
                laypage.render({
                    elem: 'order_page' //注意，这里的 test1 是 ID，不用加 # 号
                    ,count: total //数据总数，从服务端得到
                    ,curr:page
                    ,jump:function (obj,first) {
                        if(!first){
                            pageNow = obj.curr;
                            getData(obj.curr-1,CustomerID);
                        }
                    }
                });
                //监听指定开关
            });
        }
    });
</script>

</body>

</html>
