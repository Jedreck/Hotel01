<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Dashboard">
    <meta name="keyword" content="Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">
    <title>订单记录</title>

    <!-- Favicons -->
    <link href="../../img/favicon.png" rel="icon">
    <link href="../../img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Bootstrap core CSS -->
    <link href="../../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!--external css-->
    <link href="../../lib/font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="../../css/zabuto_calendar.css">
    <link rel="stylesheet" type="text/css" href="../../lib/gritter/css/jquery.gritter.css"/>
    <!-- Custom styles for this template -->
    <link href="../../css/style.css" rel="stylesheet">
    <link href="../../css/style-responsive.css" rel="stylesheet">
    <script src="../../lib/chart-master/Chart.js"></script>
    <script type="text/javascript" src="../../lib/layui/layui.all.js"></script>
    <link href="../../lib/layui/css/layui.css" rel="stylesheet" type="text/css"/>
    <script src="../../lib/jquery/jquery.js"></script>

    <!-- =======================================================
      Template Name: Dashio
      Template URL: https://templatemag.com/dashio-bootstrap-admin-template/
      Author: TemplateMag.com
      License: https://templatemag.com/license/
    ======================================================= -->
</head>

<body>
<section id="container">
    <!-- **********************************************************************************************************************************************************
        TOP BAR CONTENT & NOTIFICATIONS
        *********************************************************************************************************************************************************** -->
    <!--header start-->
    <header class="header black-bg">
        <div class="sidebar-toggle-box">
            <div class="fa fa-bars tooltips" data-placement="right" data-original-title="Toggle Navigation"></div>
        </div>
        <!--logo start-->
        <a href="index.html" class="logo"><b>酒店<span>预订</span></b></a>
        <!--logo end-->
        <div class="nav notify-row" id="top_menu">
            <!--  notification start -->
            <ul class="nav top-menu">
                <!-- settings start -->
                <li class="dropdown">
                    <a data-toggle="dropdown" class="dropdown-toggle" href="index.html#">
                        <i class="fa fa-tasks"></i>
                        <div id="red_num">
                            <span class="badge bg-theme"></span>
                        </div>

                    </a>
                    <ul class="dropdown-menu extended tasks-bar">
                        <div class="notify-arrow notify-arrow-green"></div>
                        <li>
                            <p class="green">你有待接收的预定</p>
                        </li>
                        <li class="external">
                            <a href="/html/staff/unaccept_booking_orders.html">查看详情</a>
                        </li>
                    </ul>
                </li>
                <!-- settings end -->
            </ul>
        </div>
        <div class="top-menu">
            <ul class="nav pull-right top-menu">
                <li><a class="logout" onclick="logout()">登出</a></li>
            </ul>
        </div>
    </header>
    <!--header end-->


    <!-- **********************************************************************************************************************************************************
        MAIN SIDEBAR MENU
        *********************************************************************************************************************************************************** -->
    <!--sidebar start-->
    <aside>
        <div id="sidebar" class="nav-collapse ">
            <!-- sidebar menu start-->
            <ul class="sidebar-menu" id="nav-accordion">
                <p class="centered"><a href="profile.html"><img src="../../img/ui-sam.jpg" class="img-circle" width="80"></a></p>
                <h5 class="centered">Sam Soffes</h5>

                <li class="mt">
                    <a class="active" href="#">
                        <i class="glyphicon glyphicon-home"></i>
                        <span>首页</span>
                    </a>
                </li>

                <li class="sub-menu">
                    <a href="javascript:;">
                        <i class="glyphicon glyphicon-pencil"></i>
                        <span>预定订单管理</span>
                    </a>
                    <ul class="sub">
                        <li><a href="unaccept_booking_orders.html">待接受的订单</a></li>
                        <li><a href="accept_booking_orders.html">已接收的订单</a></li>
                    </ul>
                </li>


                <li class="sub-menu">
                    <a class="active" href="#">
                        <i class="glyphicon glyphicon-time"></i>
                        <span>办理入住</span>
                    </a>
                    <ul class="sub">
                        <li><a href="check_in_now.html">网上未预定入住</a></li>
                        <li><a href="check_in_net.html">网上预定入住</a></li>
                    </ul>
                </li>

                <li class="sub-menu">
                    <a class="" href="close_account.html">
                        <i class="glyphicon glyphicon-time"></i>
                        <span>结算</span>
                    </a>
                </li>
            </ul>
            <!-- sidebar menu end-->
        </div>
    </aside>
    <!--sidebar end-->


    <!-- **********************************************************************************************************************************************************
        MAIN CONTENT
        *********************************************************************************************************************************************************** -->
    <!--main content start-->
    <section id="main-content">
        <section class="wrapper">
            <div class="row mt" style="height:600px;">
                <br/>
                <br/>
                <br/>
                <div class="col-md-12">
                    <div class="content-panel">

                        <table class="table table-striped table-advance table-hover">
                            <h4><i class="fa fa-angle-right"></i>选择房间</h4>
                            <hr>
                            <thead>
                            <tr>
                                <th><i class="fa fa-home"> 房间号</i></th>
                                <th><i class="fa fa-level-up"></i> 楼层</th>
                                <th class="hidden-phone"><i class="fa fa-list-alt"></i> 房间类型</th>
                                <th><i class="fa fa-bed"></i> 床型</th>
                                <th><i class=" fa fa-th-large"></i> 面积</th>
                                <th></th>
                            </tr>
                            </thead>

                            <tbody id="table_content">
                            <!--<tr>-->
                            <!--<td id="order_number">001</td>-->
                            <!--<td class="hidden-phone" id="order_name">李涛</td>-->
                            <!--<td id="check_in_date">2018-12-31</td>-->
                            <!--<td id="order_price">12000.00$</td>-->
                            <!--<td><span class="label label-info label-mini" id="order_state">Due</span></td>-->
                            <!--<td>-->
                            <!--<button class="btn btn-success btn-xs" name="detail"><i class="fa fa-check"></i></button>-->
                            <!--</td>-->
                            <!--</tr>-->
                            </tbody>

                        </table>

                    </div>
                    <!-- /content-panel -->
                </div>
                <!-- /col-md-12 -->
            </div>

            <!-- /row -->
        </section>
    </section>
    <!--main content end-->

    <!--分页-->

    <div id="order_page" style="text-align: center"></div>
    <!--分页-->

    <!--footer start-->
    <footer class="site-footer">
        <div class="text-center">
            <p>
                &copy; Copyrights <strong>Dashio</strong>. All Rights Reserved
            </p>
            <div class="credits">
                <!--
                  You are NOT allowed to delete the credit link to TemplateMag with free version.
                  You can delete the credit link only if you bought the pro version.
                  Buy the pro version with working PHP/AJAX contact form: https://templatemag.com/dashio-bootstrap-admin-template/
                  Licensing information: https://templatemag.com/license/
                -->
                Created with Dashio template by <a href="https://templatemag.com/">TemplateMag</a>
            </div>
            <a href="index.html#" class="go-top">
                <i class="fa fa-angle-up"></i>
            </a>
        </div>
    </footer>
    <!--footer end-->
</section>
<!-- js placed at the end of the document so the pages load faster -->
<script src="../../lib/jquery/jquery.min.js"></script>
<script src="../../lib/jquery-ui-1.9.2.custom.min.js"></script>

<script src="../../lib/bootstrap/js/bootstrap.min.js"></script>
<script class="include" type="text/javascript" src="../../lib/jquery.dcjqaccordion.2.7.js"></script>
<script src="../../lib/jquery.scrollTo.min.js"></script>
<script src="../../lib/jquery.nicescroll.js" type="text/javascript"></script>
<script src="../../lib/jquery.sparkline.js"></script>
<!--common script for all pages-->
<script src="../../lib/common-scripts.js"></script>
<script type="text/javascript" src="../../lib/gritter/js/jquery.gritter.js"></script>
<script type="text/javascript" src="../../lib/gritter-conf.js"></script>
<!--script for this page-->
<script src="../../lib/sparkline-chart.js"></script>
<script src="../../lib/zabuto_calendar.js"></script>


<script src="../../lib/layui/layui.js"></script>

<script src="../../lib/easyCookie.js"></script>
<script src="../../lib/my_common.js"></script>

<script>
    layui.use(['laypage','form','layer'], function(){
        var form = layui.form;
        var laypage = layui.laypage;
        var layer = layui.layer;
    });
</script>
<script type="application/javascript">

    window.onload = function () {
        getUnreadNumStaff();
    };

    $(function() {
        if(!validateEmployee()) return;
        var pageNum = 0;//用来接收订单数量
        var obj;//用来接收查询的订单列表
        var pageNow = 1;// 当前的页
        var order_number = null;//用来获取上个界面传来的订单号
        //var R_roomtype = "25";//当前用户的身份证号

        initialData();

        //初始化数据
        function initialData(){
            order_number = sessionStorage.getItem("order_number");
            getData(0,order_number);
        }

        /**
         *
         * @param page 当前的页号
         * @param R_roomtype 客户选择的房间号
         */

        function getData(page,order_number) {
            showProcess("table_content",6);
            $.ajax({
                url: "/SelectRoomCanCheckInServlet",
                type:'post',
                data:{page:page,order_number:order_number},
                dataType:'text',
                success: function(data){
                    var str = data.split("!");
                    var total = parseInt(str[1]);
                    // 后台查询失败
                    if(str == "Error") {
                        $("#table_content").html("1加载数据失败，请稍后重试!");
                        return;
                    }
                    obj = JSON.parse(str[0]);
                    // 后台没有数据
                    if(obj.length == 0) {
                        $("#table_content").html("您没有可用的房间");
                        return
                    }
                    // 后台有>=1条数据
                    initialTable(page+1,obj,total,order_number);
                },
                error:  function () {
                    $("#table_content").html("2加载数据失败，请稍后重试!");
                }
            });
        }

        /**
         *
         * @param page 当前的页号
         * @param obj 获取当前页的数据
         * @param total 数据总量，用于设置分页
         *  @param R_roomtype 用户选择的房间类型
         */
        // 初始化表格
        function initialTable(page,obj,total,order_number){
            pageNum = obj.length;
            setPage(page,total,order_number);
            var html = "";
            for(var i = 0; i < obj.length; i++){
                // 拼接内容
                html += "        <tr>\n" +
                    "            <td name=\"room_number\">";
                html += obj[i].R_num;
                html += "</td>\n" +
                    "            <td class=\"hidden-phone\" name=\"room_floor\">";
                html += obj[i].R_floor;
                html += "</td>\n" +
                    "            <td name=\"roomtypename\">";
                html += obj[i].typename;
                html += "</td>\n" +
                    "            <td name=\"bedtype\">";
                html += obj[i].bedtype;
                html += "</td>\n" +
                    "             <td name=\"area\"><span class=\"label label-info label-mini\">";
                html += obj[i].area;
                html += "</span></td>\n" +
                    "            <td>\n" +
                    "             <button class=\"btn btn-success btn-xs\" name=\"choose_room\"><i class=\"fa fa-check\"></i></button>\n" +
                    "            </td>\n" +
                    "            </tr>";
            }
            $("#table_content").html(html);

            // 详细信息和修改
            $("button[name='choose_room']").click(function () {
                var O_num = sessionStorage.getItem("order_number");
                var R_num = $($(this).parent().parent()).find("td[name='room_number']").html();
                //console.log(O_num);
                //console.log(R_num);
                layer.open({
                    content: '确定预订该房间吗？'
                    ,btn: ['确定', '再想想']
                    ,yes: function(index, layero){//删除
                        layer.closeAll();
                        CheckInRoom(O_num,R_num);
                    }
                    ,btn2: function(index, layero){
                        //按钮【按钮二】的回调

                        //return false 开启该代码可禁止点击该按钮关闭
                    }
                    ,cancel: function(){
                        //右上角关闭回调

                        //return false 开启该代码可禁止点击该按钮关闭
                    }
                });
            });

        }

        function CheckInRoom(O_num,R_num) {
            $.ajax({
                url: "/ChangeRoomstateForCheckInServlet",
                type:'post',
                data:{O_num:O_num,R_num:R_num},
                dataType:'text',
                success: function(data){
                    // 后台删除失败
                    if(data != "入住成功") {
                        showInsertResult("1入住房间失败！");
                    } else {
                        showInsertResult("入住房间成功！");
                        getData(pageNow-1,O_num);// 重新获取数据
                        setTimeout(function(){window.open('./check_in_net.html','_self');},5000);
                        //window.open('./check_in_net.html','_self');
                    }
                },
                error: function () {
                    showInsertResult("2222入住房间失败！");
                }
            });
        }

        // 显示删除的结果
        function showInsertResult(content) {
            layer.open({
                content: content
                ,btn: ['确定']
                ,yes: function(index, layero){//删除
                    layer.closeAll();
                }
                ,cancel: function(){
                }
            });
        }

        /**
         *
         * @param page 当前的页号
         * @param total 数据总量，用于设置分页
         *  @param R_roomtype 客户选择的房间类型
         */
        // 设置分页数量
        function setPage(page,total,order_number) {
            //console.log(pageNum);
            layui.use(['laypage','form','layer'], function(){
                var form = layui.form;
                var laypage = layui.laypage;
                var layer = layui.layer;
                //执行一个laypage实例
                laypage.render({
                    elem: 'order_page' //注意，这里的 test1 是 ID，不用加 # 号
                    ,count: total //数据总数，从服务端得到
                    ,curr:page
                    ,jump:function (obj,first) {
                        if(!first){
                            pageNow = obj.curr;
                            getData(obj.curr-1,order_number);
                        }
                    }
                });
                //监听指定开关
            });
        }
    });
</script>

</body>

</html>
